name: Publish release to NPM
on:
  workflow_dispatch:

permissions:
  id-token: write  # Required for OIDC
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Configure git credentials
        uses: OleksiyRudenko/gha-git-credentials@v2-latest
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Attach to main branch
        run: git checkout main && git pull
      # Setup .npmrc file to publish to npm
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'
          cache: 'yarn'
          # Defaults to the user or organization that owns the workflow file
          scope: '@rimbu'
      - name: Clear auth token for OIDC
        run: echo "NODE_AUTH_TOKEN=" >> $GITHUB_ENV
      - name: Upgrade npm for OIDC
        run: npm install -g npm@latest
      - run: yarn install --frozen-lockfile
      - name: Build
        run: yarn build
      - name: Bump versions and publish packages
        run: yarn version:ci
        env:
          GH_TOKEN: ${{secrets.GITHUB_TOKEN}}
      - name: Debug npm access for failing packages
        run: |
          set -euo pipefail
          echo "Registry: $(npm config get registry)"
          echo "HOME: $HOME"
          echo "List home files:"
          ls -la $HOME || true
          echo "Show ~/.npmrc (if present)"
          cat ~/.npmrc || true

          echo "Whoami (should show a username if OIDC succeeded)"
          npm whoami || echo "npm whoami failed (not authenticated)"

          echo "Testing per-package dry-run publish for debug"
          FAILING=("typical" "spy" "common")
          for pkg in "${FAILING[@]}"; do
            echo "---- Debugging @rimbu/$pkg ----"
            cd packages/$pkg
            echo "npm config for package:"
            npm config list || true
            echo "Attempting npm publish --dry-run --access public"
            npm publish --dry-run --access public || echo "publish dry-run failed for @rimbu/$pkg"
            cd - >/dev/null
          done

          echo "Finally: run lerna publish in verbose mode (no-op here if you don't want to actually publish)"
          npx lerna publish from-package --yes --loglevel verbose || true
      - name: Publish packages
        run: npx lerna publish from-package --yes
        env:
          GH_TOKEN: ${{secrets.GITHUB_TOKEN}}
